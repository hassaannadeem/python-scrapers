__author__ = 'shawn'
import mechanize
import cookielib
import xlrd
import sys
from xml.sax import saxutils, parse
from xml.sax import handler

class ExcelHandler(handler.ContentHandler):
    def __init__(self):
        self.chars = [  ]
        self.cells = [  ]
        self.rows = [  ]
        self.tables = [  ]
    def characters(self, content):
        self.chars.append(content)
    def startElement(self, name, atts):
        if name=="Cell":
            self.chars = [  ]
        elif name=="Row":
            self.cells=[  ]
        elif name=="Table":
            self.rows = [  ]
    def endElement(self, name):
        if name=="Cell":
            self.cells.append(''.join(self.chars))
        elif name=="Row":
            self.rows.append(self.cells)
        elif name=="Table":
            self.tables.append(self.rows)


br= mechanize.Browser()
# Cookie Jar
cj = cookielib.LWPCookieJar()
br.set_cookiejar(cj)

# Browser options
br.set_handle_equiv(True)
#br.set_handle_gzip(True)
br.set_handle_redirect(True)
br.set_handle_referer(True)
br.set_handle_robots(False)

# Follows refresh 0 but not hangs on refresh > 0
br.set_handle_refresh(mechanize._http.HTTPRefreshProcessor(), max_time=1)

# User-Agent (this is cheating, ok?)
br.addheaders = [('User-agent', 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1) Gecko/2008071615 Fedora/3.0.1-1.fc9 Firefox/3.0.1')]

# Set the page to open
url='URL HERE'
response = br.open(url)


#uncomment to print forms
for form in br.forms():
    print "Form name:", form.name
    print form
br.form = list(br.forms())[1]
br.form.set_all_readonly(False)
br.select_form(nr=1)
br.form['portfolios']='239726-239623-239458-239706-239566-239708-239763-239710-239637-239665-239774-239467-239565-239707-239826-239500-239725-239452-239644-239718-239451-239456-239695-239454-244049-244050-239728-239465-239561-239455-239719-239766-239463-239699-239466-239714-239717-239709-239712-239626-239600-239627-239650-239762-239855-239536-239723-239563-239572-239764-259622-239520-239534-239482-239775-239724-239659-239773-239681-239641-239736-239628-239605-239499-239522-268708-239854-239686-239622-239601-239690-256101-239468-239464-239615-239594-239619-239612-239511-239657-239674-244048-239744-239737-239512-239607-239685-239508-239670-251614-258100-239772-239768-239506-239741-239683-239507-239746-239513-264617-239453-239460-239713-239769-259623-239516-239580-239423-239524-239664-239543-239505-239771-239750-239519-239756-239716-239715-239757-259624-251616-272532-239510-239740-239502-239758-239540-239720-239450-239457-239579-264619-239501-239509-239830-239514-239761-239731-244051-239582-264615-239678-239523-239667-239765-239528-239521-239649-264623-239729-239661-239751-239545-239648-239462-239692-239588-239705-239503-239684-239680-239689-239517-239730-239581-239668-270319-239739-239618-239688-239733-239669-239675-239742-239767-239677-239645-239585-271054-239518-239583-251465-239696-268704-239666-239610-251474-239586-239430-279626-239584-239459-239752-239662-239748-239671-239745-239722-239676-239614-239424-239753-239831-239550-239526-239734-239429-258098-239504-239829-239663-268752-239606-239629-254263-239461-239515-239587-254551-271056-258510-239642-264507-239721-239551-239770-254553-239655-239621-239654-239529-269394-239431-239738-271544-239544-272343-272341-254555-254549-272342-239539-272824-239672-260973-264503-273753-251476-239609-239660-239537-272340-272822-239527-239735-264273-264542-251477-239445-272346-264544-251475-239693-272344-264613-275382-272112-239653-239443-264275-272345-264611-239651-273746-239652-239570-276546-239525-239647-239759-239530-239613-239620-239656-254562-272819-239673-276544-260652-260975-239691-239552-258806-271538-271540-264127-239444-273743-280052-273775-275389-273771-239638-275397-253433-279286-272823-264606-275384-272821-272825-271542-273750-272820-280048-280050-280051-275399-280049-280769-280774-273763-273748-273759-280771-273766-273768-270316'
br.submit()
with open("excel2.xml", "w") as f1:
    f1.write(br.response().read())
f1.close()
excelHandler = ExcelHandler( )
parse("excel2.xml", excelHandler)
for e in excelHandler.rows:
    print "%s,%s,%s,%s,%s,%s,%s \n" %(e[0].replace("\n", ""),e[1].replace("\n", ""),e[5].replace("\n", ""),e[7].replace("\n", ""),e[8].replace("\n", ""),e[11].replace("\n", ""),(e[12]).replace("\n", ""))
